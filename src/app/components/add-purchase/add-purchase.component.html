<app-modal [modalRef]="modalRef" 
            title="Purchase Entry">
    <form [formGroup]="addPurchaseForm">
        <div class="form-row">
            <div class="form-group col-md-6">
                <label for="invoiceNo"><i class="fa fa-file-invoice"></i> Invoice No.</label>
                <input type="text"
                    class="form-control"
                    id="invoiceNo"
                    placeholder="Enter invoice number..."
                    formControlName="invoice_id">
            </div>
            <div class="form-group col-md-6">
                <label for="timestamp"><i class="fa fa-calendar"></i> Date</label>
                <input type="text"
                    class="form-control"
                    bsDatepicker
                    formControlName="timestamp"
                    [bsConfig]="{ dateInputFormat: 'DD/MM/YYYY', containerClass: 'theme-dark-blue' }" />
            </div>
        </div>
        <div class="form-group">
            <label for="vendor">
                <i class="fa fa-building"></i> Vendor
                <button type="button" 
                        class="btn btn-sm btn-link p-0 ml-2" 
                        (click)="openAddVendorModal()"
                        title="Add new vendor">
                    <i class="fa fa-plus-circle text-primary"></i>
                </button>
            </label>
            <input type="text"
                   class="form-control"
                   id="vendor"
                   placeholder="Search vendor..."
                   [typeahead]="parties"
                   typeaheadOptionField="name"
                   (typeaheadOnSelect)="onSelectVendor($event)"
                   (blur)="validateVendorField()"
                   [typeaheadScrollable]="true"
                   formControlName="selected_vendor">
            <div *ngIf="selectedVendor.touched && selectedVendor.errors?.required" class="alert alert-danger">
                <div>Vendor is required.</div>
            </div>
            <div *ngIf="selectedVendor.touched && selectedVendor.errors?.vendorNotSelected" class="alert alert-danger">
                <div>Please select a vendor from the dropdown suggestions.</div>
            </div>
        </div>
        <div class="form-group">
            <label for="item">
                <i class="fa fa-box"></i> Item
                <button type="button" 
                        class="btn btn-sm btn-link p-0 ml-2" 
                        (click)="openAddItemModal()"
                        title="Add new item">
                    <i class="fa fa-plus-circle text-primary"></i>
                </button>
            </label>
            <input type="text"
                class="form-control"
                id="item"
                name="purchase-item"
                placeholder="Search item..."
                [typeahead]="items"
                [typeaheadItemTemplate]="customItemTemplate"
                typeaheadOptionField="name"
                (typeaheadOnSelect)="onSelectItem($event)"
                (blur)="validateItemField()"
                [typeaheadScrollable]="true"
                formControlName="selected_item">
                <ng-template #customItemTemplate let-item="item">
                   {{item.name}} Grade: {{item.grade}} Size: {{item.size}}
                </ng-template>
            <div *ngIf="selectedItem.touched && selectedItem.errors?.required" class="alert alert-danger">
                <div>Item is required.</div>
            </div>
            <div *ngIf="selectedItem.touched && selectedItem.errors?.itemNotSelected" class="alert alert-danger">
                <div>Please select an item from the dropdown suggestions.</div>
            </div>
        </div>
        <div class="form-row">
            <div class="form-group col-md-6" formGroupName="quantity">
                <label for="value"><i class="fa fa-balance-scale"></i> Quantity</label>
                <div class="input-group">
                    <input appDecimalNumber
                           type="text"
                           class="form-control"
                           id="value"
                           formControlName="value">
                    <div class="input-group-append">
                        <select class="custom-select" formControlName="unit">
                            <option *ngFor="let unit of unitValues"
                                    [value]="unit">
                              {{ quantityUnitToLabelMapping[unit] }}
                            </option>
                          </select>
                    </div>
                </div>
                <!-- Show minimum quantity hint when editing -->
                <small *ngIf="purchase?.purchase_id && processedInfo && processedInfo.total_processed > 0" 
                       class="form-text text-info">
                    <i class="fa fa-info-circle"></i> Minimum: {{minQuantity | number:'1.2-2'}} {{quantityUnitToLabelMapping[value.parent?.get('unit')?.value || 'KG']}} 
                    ({{processedInfo.total_manufacturing | number:'1.2-2'}} in manufacturing, 
                    {{processedInfo.total_finished | number:'1.2-2'}} in finished goods,
                    {{processedInfo.total_sold || 0 | number:'1.2-2'}} sold)
                </small>
                <div *ngIf="value.touched && value.errors?.required" class="alert alert-danger">
                    <div>Quantity is required.</div>
                </div>
                <div *ngIf="value.touched && value.errors?.minQuantity" class="alert alert-danger">
                    <div>Quantity cannot be less than {{minQuantity | number:'1.2-2'}} {{quantityUnitToLabelMapping[value.parent?.get('unit')?.value || 'KG']}} 
                    (already processed: {{processedInfo?.total_manufacturing | number:'1.2-2'}} in manufacturing, 
                    {{processedInfo?.total_finished | number:'1.2-2'}} in finished goods,
                    {{processedInfo?.total_sold || 0 | number:'1.2-2'}} sold)</div>
                </div>
            </div>
            <div class="form-group col-md-6">
                <label for="rate"><i class="fa fa-rupee"></i> Rate</label>
                <input appDecimalNumber
                       type="text"
                       class="form-control"
                       id="rate"
                       formControlName="rate">
                <div *ngIf="rate.touched && rate.errors?.required" class="alert alert-danger">
                    <div>Rate is required.</div>
                </div>
            </div>
        </div>
        
        <div class="button-group mt-3">
            <div class="button-row">
                <button class="btn btn-secondary"
                        (click)="applyToNext()">
                  <i class="fa fa-redo"></i> Apply to Next
                </button>
                <button class="btn btn-info"
                        (click)="nextItem()">
                  <i class="fa fa-arrow-right"></i> Next Item
                </button>
            </div>
            <div class="button-row">
                <button class="btn btn-primary"
                        (click)="doneAndPrintLabels()">
                  <i class="fa fa-check"></i> Done and Print Labels
                </button>
            </div>
        </div>
    </form>
</app-modal>