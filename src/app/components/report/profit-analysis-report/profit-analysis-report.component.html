<div class="container-fluid">
  <div class="report-header">
    <div class="header-content">
      <h2><i class="fa fa-line-chart"></i> Profit Analysis Report</h2>
      <p class="text-muted">Sales vs Purchase comparison with gross margins (excludes operating costs)</p>
    </div>
    <div class="header-actions">
      <button type="button" class="btn btn-primary" (click)="exportToExcel()" [disabled]="items.length === 0">
        <i class="fa fa-download"></i> Export to Excel
      </button>
    </div>
  </div>

  <div class="filters-section">
    <div class="row">
      <div class="col-md-3">
        <label>Start Date</label>
        <input type="date" class="form-control" [(ngModel)]="startDate" (change)="onDateFilterChange()">
      </div>
      <div class="col-md-3">
        <label>End Date</label>
        <input type="date" class="form-control" [(ngModel)]="endDate" (change)="onDateFilterChange()">
      </div>
    </div>
  </div>

  <div class="summary-cards" *ngIf="summary">
    <div class="summary-card">
      <div class="summary-label">Total Items</div>
      <div class="summary-value">{{summary.total_items || 0}}</div>
    </div>
    <div class="summary-card">
      <div class="summary-label">Total Sales</div>
      <div class="summary-value">{{formatCurrency(summary.total_sales || 0)}}</div>
    </div>
    <div class="summary-card">
      <div class="summary-label">Total Purchases</div>
      <div class="summary-value">{{formatCurrency(summary.total_purchases || 0)}}</div>
    </div>
    <div class="summary-card" [ngClass]="getProfitClass(summary.total_profit || 0)">
      <div class="summary-label">Gross Profit</div>
      <div class="summary-value">{{formatCurrency(summary.total_profit || 0)}}</div>
    </div>
    <div class="summary-card" [ngClass]="getProfitClass(summary.total_profit || 0)">
      <div class="summary-label">Gross Margin</div>
      <div class="summary-value">{{(summary.overall_margin_percentage || 0).toFixed(2)}}%</div>
    </div>
  </div>

  <div class="loading-spinner" *ngIf="isLoading">
    <i class="fa fa-spinner fa-spin"></i> Loading report...
  </div>

  <app-data-grid
    *ngIf="!isLoading"
    [columns]="columns"
    [data]="items"
    [showSearch]="true"
    [showActions]="false"
    [trackByFn]="trackByItemId"
    searchPlaceholder="Search items...">
    <div headerCenter>
      <div class="summary-inline" *ngIf="summary">
        <span class="summary-inline-label">Gross Profit:</span>
        <span class="summary-inline-value" [ngClass]="getProfitClass(summary.total_profit || 0)">
          {{formatCurrency(summary.total_profit || 0)}}
        </span>
        <span class="summary-inline-separator">|</span>
        <span class="summary-inline-label">Gross Margin:</span>
        <span class="summary-inline-value" [ngClass]="getProfitClass(summary.total_profit || 0)">
          {{(summary.overall_margin_percentage || 0).toFixed(2)}}%
        </span>
      </div>
    </div>
  </app-data-grid>

  <div *ngIf="!isLoading && items.length === 0" class="empty-state">
    <i class="fa fa-inbox"></i>
    <p>No data found for the selected date range</p>
  </div>
</div>

<!-- Profit Template -->
<ng-template #profitTemplate let-row let-value="value">
  <span [ngClass]="getProfitClass(row.profit?.amount || 0)">
    {{formatCurrency(row.profit?.amount || 0)}}
  </span>
</ng-template>

<!-- Margin Template -->
<ng-template #marginTemplate let-row let-value="value">
  <span [ngClass]="getProfitClass(row.profit?.amount || 0)">
    {{(row.profit?.margin_percentage || 0).toFixed(2)}}%
  </span>
</ng-template>
