<app-modal [modalRef]="modalRef" 
            title="Process Raw Material">
    <form [formGroup]="addInventoryItemForm">
        <!-- Show source item info (always show if parentItem exists) -->
        <div *ngIf="parentItem" class="alert alert-info">
            <strong><i class="fa fa-industry"></i> Source:</strong> {{parentItem.name}} 
            Grade: {{parentItem.grade}} Size: {{parentItem.size}}<br>
            <span *ngIf="availableQuantity">
                <strong>Available:</strong> {{availableQuantity.value}} {{quantityUnitToLabelMapping[availableQuantity.unit]}}
                <span *ngIf="sourceRate > 0"> at Rs. {{sourceRate}}/{{quantityUnitToLabelMapping[availableQuantity.unit]}}</span>
            </span>
            <span *ngIf="manufactureEntry?.source_barcode"><br><strong>Barcode:</strong> {{manufactureEntry.source_barcode}}</span>
        </div>

        <div class="form-group">
            <label for="timestamp"><i class="fa fa-calendar"></i> Date</label>
            <input type="text"
                class="form-control"
                bsDatepicker
                formControlName="timestamp"
                [bsConfig]="{ dateInputFormat: 'DD/MM/YYYY', containerClass: 'theme-dark-blue' }" />
        </div>

        <!-- Processing Type (required) -->
        <div class="form-group">
            <label for="processing_type"><i class="fa fa-cog"></i> Processing Type</label>
            <select class="form-control" formControlName="processing_type">
                <option value="">Select processing type...</option>
                <option *ngFor="let pt of processingTypes" [value]="pt.value">
                    {{pt.label}} (+Rs. {{pt.charge}}/{{quantityUnitToLabelMapping[availableQuantity?.unit || 'KG']}})
                </option>
            </select>
            <div *ngIf="processingType.touched && processingType.errors?.required" class="alert alert-danger">
                <div>Processing type is required.</div>
            </div>
        </div>

        <div class="form-group">
            <label for="item"><i class="fa fa-box"></i> Sub-Item</label>
            <input type="text"
                class="form-control"
                id="item"
                name="inventory-item"
                placeholder="Search sub-item (S-Cut/Conditioned)..."
                [typeahead]="items"
                [typeaheadItemTemplate]="customItemTemplate"
                typeaheadOptionField="name"
                [typeaheadScrollable]="true"
                [typeaheadMinLength]="0"
                (typeaheadOnSelect)="onSelect($event)"
                formControlName="selected_item">
                <ng-template #customItemTemplate let-item="item">
                   {{item.name}} Grade: {{item.grade}} Size: {{item.size}}
                </ng-template>
            <div *ngIf="selectedItem.touched && selectedItem.errors?.required" class="alert alert-danger">
                <div>Item is required.</div>
            </div>
        </div>
        <div class="form-row">
            <div class="form-group col-md-6" formGroupName="quantity">
                <label for="value"><i class="fa fa-balance-scale"></i> Weight</label>
                <div class="input-group">
                    <input appDecimalNumber
                           type="text"
                           class="form-control"
                           id="value"
                           formControlName="value"
                           [max]="availableQuantity?.value"
                           placeholder="Enter weight">
                    <div class="input-group-append">
                        <select class="custom-select" formControlName="unit">
                            <option *ngFor="let unit of unitValues"
                                    [value]="unit">
                                {{ quantityUnitToLabelMapping[unit] }}
                            </option>
                            </select>
                    </div>
                </div>
                <small *ngIf="availableQuantity" class="form-text text-muted">
                    Max: {{availableQuantity.value}} {{quantityUnitToLabelMapping[availableQuantity.unit]}}
                </small>
                <div *ngIf="value.touched && value.errors?.required" class="alert alert-danger">
                    <div>Quantity is required.</div>
                </div>
                <div *ngIf="value.touched && value.errors?.max" class="alert alert-danger">
                    <div>Quantity cannot exceed {{availableQuantity?.value}} {{quantityUnitToLabelMapping[availableQuantity?.unit]}}.</div>
                </div>
            </div>
            <div class="form-group col-md-6">
                <label for="rate"><i class="fa fa-rupee"></i> Rate (Auto-calculated)</label>
                <input appDecimalNumber
                       type="text"
                       class="form-control"
                       id="rate"
                       formControlName="rate"
                       readonly>
                <small class="form-text text-muted">
                    Source rate + Processing charge
                </small>
            </div>
        </div>
        <div class="button-group">
            <div class="button-row">
                <button class="btn btn-primary"
                        [disabled]="!addInventoryItemForm.valid"
                        (click)="doneAndPrintLabels()">
                  <i class="fa fa-check"></i> Done and Print Labels
                </button>
            </div>
        </div>
    </form>
</app-modal>
