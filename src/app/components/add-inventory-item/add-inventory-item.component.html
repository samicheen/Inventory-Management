<app-modal [modalRef]="modalRef" 
            [title]="isInitialStockMode ? 'Add Initial Stock' : 'Process Raw Material'">
    <form [formGroup]="addInventoryItemForm">
        <!-- Show source item info (only for processing mode) -->
        <div *ngIf="!isInitialStockMode && parentItem" class="alert alert-info">
            <strong><i class="fa fa-industry"></i> Source:</strong> {{parentItem.name}} 
            Grade: {{parentItem.grade}} Size: {{parentItem.size}}<br>
            <span *ngIf="availableQuantity">
                <strong>Available:</strong> {{availableQuantity.value}} {{quantityUnitToLabelMapping[availableQuantity.unit]}}
                <span *ngIf="sourceRate > 0"> at Rs. {{sourceRate}}/{{quantityUnitToLabelMapping[availableQuantity.unit]}}</span>
            </span>
            <span *ngIf="manufactureEntry?.source_barcode"><br><strong>Barcode:</strong> {{manufactureEntry.source_barcode}}</span>
        </div>

        <div class="form-group">
            <label for="timestamp"><i class="fa fa-calendar"></i> Date</label>
            <input type="text"
                class="form-control"
                id="timestamp"
                bsDatepicker
                formControlName="timestamp"
                [bsConfig]="{ dateInputFormat: 'DD/MM/YYYY', containerClass: 'theme-dark-blue' }" />
        </div>

        <!-- Processing Type (required only for processing mode) -->
        <div *ngIf="!isInitialStockMode" class="form-group">
            <label for="processing_type"><i class="fa fa-cog"></i> Processing Type</label>
            <select class="form-control" formControlName="processing_type">
                <option value="">Select processing type...</option>
                <option *ngFor="let pt of processingTypes" [value]="pt.value">
                    {{pt.label}} (+Rs. {{pt.charge}}/{{quantityUnitToLabelMapping[availableQuantity?.unit || 'KG']}})
                </option>
            </select>
            <div *ngIf="processingType.touched && processingType.errors?.required" class="alert alert-danger">
                <div>Processing type is required.</div>
            </div>
        </div>

        <!-- Packages FormArray -->
        <div class="form-group">
            <label><i class="fa fa-box"></i> Packages</label>
            <div formArrayName="packages">
                <div *ngFor="let package of packages.controls; let i = index" 
                     [formGroupName]="i" 
                     class="package-row mb-3 p-3 border rounded">
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <h6 class="mb-0">Package #{{i + 1}}</h6>
                        <button type="button" 
                                class="btn btn-sm btn-danger" 
                                *ngIf="packages.length > 1"
                                (click)="removePackage(i)">
                            <i class="fa fa-trash"></i> Remove
                        </button>
                    </div>
                    
                    <div class="form-group">
                        <label>Item</label>
                        <input type="text"
                            class="form-control"
                            [id]="'item_' + i"
                            [name]="'item_' + i"
                            [placeholder]="isInitialStockMode ? 'Search item...' : 'Search sub-item (S-Cut/Conditioned)...'"
                            [typeahead]="items"
                            [typeaheadItemTemplate]="customItemTemplate"
                            typeaheadOptionField="name"
                            [typeaheadScrollable]="true"
                            [typeaheadMinLength]="0"
                            (typeaheadOnSelect)="onSelectItem($event, i)"
                            formControlName="selected_item">
                        <ng-template #customItemTemplate let-item="item">
                           {{item.name}} Grade: {{item.grade}} Size: {{item.size}}
                        </ng-template>
                        <div *ngIf="package.get('selected_item')?.touched && package.get('selected_item')?.errors?.required" 
                             class="alert alert-danger mt-1 mb-0">
                            Item is required.
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group col-md-6" [formGroupName]="'quantity'">
                            <label><i class="fa fa-balance-scale"></i> Weight per Package</label>
                            <div class="input-group">
                                <input appDecimalNumber
                                       type="text"
                                       class="form-control"
                                       formControlName="value"
                                       [max]="!isInitialStockMode ? availableQuantity?.value : null"
                                       placeholder="Enter weight">
                                <div class="input-group-append">
                                    <select class="custom-select" formControlName="unit">
                                        <option *ngFor="let unit of unitValues"
                                                [value]="unit">
                                            {{ quantityUnitToLabelMapping[unit] }}
                                        </option>
                                    </select>
                                </div>
                            </div>
                            <small *ngIf="!isInitialStockMode && availableQuantity" class="form-text text-muted">
                                Max: {{availableQuantity.value}} {{quantityUnitToLabelMapping[availableQuantity.unit]}}
                            </small>
                            <div *ngIf="package.get('quantity.value')?.touched && package.get('quantity.value')?.errors?.required" 
                                 class="alert alert-danger mt-1 mb-0">
                                Weight is required.
                            </div>
                            <div *ngIf="package.get('quantity.value')?.touched && package.get('quantity.value')?.errors?.max" 
                                 class="alert alert-danger mt-1 mb-0">
                                Weight cannot exceed {{availableQuantity?.value}} {{quantityUnitToLabelMapping[availableQuantity?.unit]}}.
                            </div>
                        </div>
                        
                        <div class="form-group col-md-6">
                            <label><i class="fa fa-hashtag"></i> Number of Packages</label>
                            <input type="number"
                                   class="form-control"
                                   formControlName="package_quantity"
                                   min="1"
                                   placeholder="1">
                            <small class="form-text text-muted">
                                How many packages have this same weight?
                            </small>
                            <div *ngIf="package.get('package_quantity')?.touched && package.get('package_quantity')?.errors?.required" 
                                 class="alert alert-danger mt-1 mb-0">
                                Number of packages is required.
                            </div>
                            <div *ngIf="package.get('package_quantity')?.touched && package.get('package_quantity')?.errors?.min" 
                                 class="alert alert-danger mt-1 mb-0">
                                Must be at least 1 package.
                            </div>
                        </div>
                    </div>
                    
                    <!-- Packaging Weight (only for processed items with KG unit) -->
                    <div *ngIf="!isInitialStockMode && package.get('quantity.unit')?.value === 'KG'" class="form-group">
                        <label><i class="fa fa-weight"></i> Packaging Weight (Kg)</label>
                        <input appDecimalNumber
                               type="text"
                               class="form-control"
                               formControlName="packaging_weight"
                               placeholder="0.00">
                        <small class="form-text text-muted">
                            Weight of packaging material (e.g., box, spool). This will be subtracted from gross weight to calculate net quantity.
                        </small>
                        <div *ngIf="package.get('packaging_weight')?.touched && package.get('packaging_weight')?.errors?.min" 
                             class="alert alert-danger mt-1 mb-0">
                            Packaging weight must be 0 or greater.
                        </div>
                    </div>
                    </div>
                    
                    <div class="form-group">
                        <label><i class="fa fa-rupee"></i> Rate {{isInitialStockMode ? '' : '(Auto-calculated)'}}</label>
                        <input appDecimalNumber
                               type="text"
                               class="form-control"
                               formControlName="rate"
                               [readonly]="!isInitialStockMode">
                        <small *ngIf="!isInitialStockMode" class="form-text text-muted">
                            Source rate + Processing charge
                        </small>
                        <small *ngIf="isInitialStockMode" class="form-text text-muted">
                            Enter rate per {{quantityUnitToLabelMapping[package.get('quantity.unit')?.value || 'KG']}}
                        </small>
                        <div *ngIf="package.get('rate')?.touched && package.get('rate')?.errors?.required" 
                             class="alert alert-danger mt-1 mb-0">
                            Rate is required.
                        </div>
                    </div>
                </div>
            </div>
            
            <button type="button" 
                    class="btn btn-sm btn-secondary mt-2" 
                    (click)="addPackage()">
                <i class="fa fa-plus"></i> Add Another Package
            </button>
        </div>
        
        <div class="button-group">
            <div class="button-row">
                <button class="btn btn-primary"
                        [disabled]="!addInventoryItemForm.valid"
                        (click)="doneAndPrintLabels()">
                  <i class="fa fa-check"></i> Done and Print Labels
                </button>
            </div>
        </div>
    </form>
</app-modal>
